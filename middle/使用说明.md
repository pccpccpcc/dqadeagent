# MiddleæœåŠ¡ä½¿ç”¨è¯´æ˜

## ğŸ‰ æœåŠ¡å·²æˆåŠŸå¯åŠ¨ï¼

### ğŸ“Š æœåŠ¡ä¿¡æ¯
- **æœåŠ¡çŠ¶æ€**: âœ… è¿è¡Œä¸­
- **è¿›ç¨‹ID**: 19362
- **æœåŠ¡åœ°å€**: http://localhost:9000
- **å¥åº·æ£€æŸ¥**: http://localhost:9000/api/health
- **æ—¥å¿—æ–‡ä»¶**: middle_service.log
- **åç«¯åœ°å€**: http://localhost:8000

### ğŸ”§ æœåŠ¡ç®¡ç†

ä½¿ç”¨ `manage.sh` è„šæœ¬ç®¡ç†æœåŠ¡ï¼š

```bash
cd /Users/pengchengchen/Desktop/dqadeagent/middle

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./manage.sh status

# åœæ­¢æœåŠ¡
./manage.sh stop

# å¯åŠ¨æœåŠ¡
./manage.sh start

# é‡å¯æœåŠ¡
./manage.sh restart

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
./manage.sh logs

# æµ‹è¯•æœåŠ¡æ¥å£
./manage.sh test

# ç¼–è¯‘é¡¹ç›®
./manage.sh build
```

### ğŸ“¡ APIæ¥å£è¯´æ˜

#### 1. å¥åº·æ£€æŸ¥æ¥å£
```bash
curl http://localhost:9000/api/health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "ok",
  "message": "å¤§ä¹”å·¥å…·è¿è¥æ•°æ®ç®¡ç†å°ä¸­é—´å±‚"
}
```

#### 2. ç»Ÿä¸€ä»£ç†æ¥å£
MiddleæœåŠ¡æä¾›ç»Ÿä¸€çš„ä»£ç†æ¥å£ï¼Œå°†å‰ç«¯è¯·æ±‚è½¬å‘åˆ°BackendæœåŠ¡ã€‚

**æ¥å£**: `POST /api/proxy`

**è¯·æ±‚æ ¼å¼**:
```json
{
  "path": "/api/template-query/stats",
  "queryDate": "2024-11-20"
}
```

**å“åº”æ ¼å¼**:
```json
{
  "code": 200,
  "data": {
    "queryDate": "2024-11-20",
    "total_count": 0,
    "success_count": 0,
    "failure_count": 0,
    "success_rate": 0.0
  }
}
```

#### 3. æ”¯æŒçš„å‚æ•°

- `path` (å¿…å¡«): Backend APIè·¯å¾„
- `queryDate`: æŸ¥è¯¢æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
- `startDate`: å¼€å§‹æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
- `endDate`: ç»“æŸæ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
- `bizSeq`: ä¸šåŠ¡æµæ°´å·

### ğŸ“ æ¥å£è°ƒç”¨ç¤ºä¾‹

#### è·å–æ¨¡æ¿æŸ¥è¯¢ç»Ÿè®¡
```bash
curl -X POST http://localhost:9000/api/proxy \
  -H "Content-Type: application/json" \
  -d '{
    "path": "/api/template-query/stats",
    "queryDate": "2024-11-20"
  }'
```

#### è·å–æ¸ é“ç»Ÿè®¡
```bash
curl -X POST http://localhost:9000/api/proxy \
  -H "Content-Type: application/json" \
  -d '{
    "path": "/api/channel-stats",
    "queryDate": "2024-11-20"
  }'
```

#### è·å–æŸ¥è¯¢è¶‹åŠ¿
```bash
curl -X POST http://localhost:9000/api/proxy \
  -H "Content-Type: application/json" \
  -d '{
    "path": "/api/weekly-query-trend",
    "startDate": "2024-11-01",
    "endDate": "2024-11-20"
  }'
```

#### è·å–æ€§èƒ½è¯¦æƒ…
```bash
curl -X POST http://localhost:9000/api/proxy \
  -H "Content-Type: application/json" \
  -d '{
    "path": "/api/performance-detail",
    "bizSeq": "your_biz_seq"
  }'
```

### ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
middle/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main/
â”‚       â”œâ”€â”€ java/
â”‚       â”‚   â””â”€â”€ com/dqadeagent/middle/
â”‚       â”‚       â”œâ”€â”€ MiddleApplication.java      # ä¸»åº”ç”¨ç±»
â”‚       â”‚       â”œâ”€â”€ controller/
â”‚       â”‚       â”‚   â””â”€â”€ ProxyController.java    # ä»£ç†æ§åˆ¶å™¨
â”‚       â”‚       â”œâ”€â”€ service/
â”‚       â”‚       â”‚   â””â”€â”€ ProxyService.java       # ä»£ç†æœåŠ¡
â”‚       â”‚       â””â”€â”€ dto/
â”‚       â”‚           â””â”€â”€ ApiRequest.java         # è¯·æ±‚DTO
â”‚       â””â”€â”€ resources/
â”‚           â””â”€â”€ application.yml                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ target/
â”‚   â””â”€â”€ middle-1.0.0.jar                       # ç¼–è¯‘åçš„JARåŒ…
â”œâ”€â”€ pom.xml                                     # Mavené…ç½®
â”œâ”€â”€ manage.sh                                   # æœåŠ¡ç®¡ç†è„šæœ¬
â”œâ”€â”€ service.pid                                 # è¿›ç¨‹IDæ–‡ä»¶
â””â”€â”€ middle_service.log                          # æœåŠ¡æ—¥å¿—
```

### âš™ï¸ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ä½äº `src/main/resources/application.yml`:

```yaml
server:
  port: 9000                    # MiddleæœåŠ¡ç«¯å£

backend:
  base-url: http://localhost:8000  # BackendæœåŠ¡åœ°å€

spring:
  web:
    cors:
      allowed-origins: "*"      # å…è®¸æ‰€æœ‰æ¥æºçš„è·¨åŸŸè¯·æ±‚
```

### ğŸ” æ•…éšœæ’æŸ¥

#### æœåŠ¡æ— æ³•å¯åŠ¨
1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
   ```bash
   lsof -i :9000
   ```

2. æ£€æŸ¥BackendæœåŠ¡æ˜¯å¦è¿è¡Œï¼š
   ```bash
   curl http://localhost:8000/
   ```

3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š
   ```bash
   tail -100 middle_service.log
   ```

#### ä»£ç†è¯·æ±‚å¤±è´¥
1. ç¡®è®¤BackendæœåŠ¡æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### é‡æ–°ç¼–è¯‘é¡¹ç›®
```bash
cd /Users/pengchengchen/Desktop/dqadeagent/middle
./manage.sh build
```

### ğŸ“Š æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f middle_service.log

# æŸ¥çœ‹æœ€å100è¡Œæ—¥å¿—
tail -100 middle_service.log

# æœç´¢é”™è¯¯æ—¥å¿—
grep ERROR middle_service.log

# æœç´¢ç‰¹å®šè¯·æ±‚çš„æ—¥å¿—
grep "template-query" middle_service.log
```

### ğŸš€ å¼€å‘è¯´æ˜

#### æ·»åŠ æ–°çš„APIè·¯å¾„
1. BackendæœåŠ¡å·²æ”¯æŒçš„æ‰€æœ‰APIè·¯å¾„éƒ½å¯ä»¥é€šè¿‡Middleä»£ç†è®¿é—®
2. åªéœ€åœ¨å‰ç«¯è°ƒç”¨æ—¶æŒ‡å®šæ­£ç¡®çš„`path`å‚æ•°å³å¯
3. Middleä¼šè‡ªåŠ¨è½¬å‘è¯·æ±‚å¹¶è¿”å›å“åº”

#### ä¿®æ”¹ä»£ç åé‡æ–°éƒ¨ç½²
```bash
# 1. åœæ­¢æœåŠ¡
./manage.sh stop

# 2. ç¼–è¯‘é¡¹ç›®
./manage.sh build

# 3. å¯åŠ¨æœåŠ¡
./manage.sh start

# æˆ–è€…ç›´æ¥é‡å¯
./manage.sh restart
```

### ğŸ” å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - ä¿®æ”¹CORSé…ç½®ï¼Œé™åˆ¶å…è®¸çš„æ¥æº
   - æ·»åŠ è®¤è¯å’Œæˆæƒæœºåˆ¶
   - é…ç½®HTTPS

2. **æ€§èƒ½ä¼˜åŒ–**
   - é…ç½®è¿æ¥æ± 
   - æ·»åŠ è¯·æ±‚ç¼“å­˜
   - å®ç°è¯·æ±‚é™æµ

3. **ç›‘æ§å’Œå‘Šè­¦**
   - é…ç½®æ—¥å¿—èšåˆ
   - æ·»åŠ æ€§èƒ½ç›‘æ§
   - è®¾ç½®å‘Šè­¦è§„åˆ™

### ğŸ“š æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Spring Boot 2.7.18
- **Javaç‰ˆæœ¬**: 1.8
- **æ„å»ºå·¥å…·**: Maven
- **WebæœåŠ¡å™¨**: Tomcat (å†…åµŒ)
- **HTTPå®¢æˆ·ç«¯**: RestTemplate, WebClient

### âš ï¸ æ³¨æ„äº‹é¡¹

1. MiddleæœåŠ¡ä¾èµ–BackendæœåŠ¡ï¼Œè¯·ç¡®ä¿BackendæœåŠ¡å…ˆå¯åŠ¨
2. é»˜è®¤é…ç½®é€‚ç”¨äºå¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦é¢å¤–é…ç½®
3. æ—¥å¿—æ–‡ä»¶ä¼šæŒç»­å¢é•¿ï¼Œå»ºè®®é…ç½®æ—¥å¿—è½®è½¬
4. æœåŠ¡é‡å¯åéœ€è¦ç­‰å¾…å‡ ç§’æ‰èƒ½å®Œå…¨å¯åŠ¨

### ğŸ†˜ è·å–å¸®åŠ©

å¦‚é‡é—®é¢˜ï¼Œè¯·ï¼š
1. è¿è¡Œ `./manage.sh test` æµ‹è¯•æœåŠ¡
2. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `middle_service.log`
3. ç¡®è®¤BackendæœåŠ¡çŠ¶æ€
4. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œç«¯å£å ç”¨

---

**æœ€åæ›´æ–°**: 2024-11-23  
**æœåŠ¡ç‰ˆæœ¬**: 1.0.0  
**Javaç‰ˆæœ¬**: 1.8.0_241  
**Spring Bootç‰ˆæœ¬**: 2.7.18

